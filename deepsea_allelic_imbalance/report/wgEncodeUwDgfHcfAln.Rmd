---
title: "Evaluation on allelic imbalanced variant (DNase's DGF) - Allelic Imbalance"
# author: Yanyu Liang
output:
    html_document:
        number_sections: true
        toc_float: true
        toc: true
        toc_depth: 3
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../')
options(width=2000)
```

# Load Data
```{r}
source('https://raw.githubusercontent.com/liangyy/deep_variant/master/rmd/my_r.R')
library(feather)
library(ggplot2)
library(reshape2)
variant_url <- 'data/wgEncodeUwDgfHcfAln.imbalance_pvalue.gz'
variant <- read.table(variant_url, sep = '\t', header = T)
score_url <- '../../../deep_variant/nick/DeepVariantPrediction/score/keras_deepsea_copy/allelic_imbalance_wgEncodeUwDgfHcfAln.wgEncodeUwDgfHcfAln_allelic_imbalance_result.feather'
score <- read_feather(score_url)
variant$Ref <- NA
variant$Ref[score$Varient.ID] <- score$Allele1
variant$Alt <- NA
variant$Alt[score$Varient.ID] <- score$Allele2
```

# Call Imbalance

Definition: ( 0.7 < Reference Allele Frequency (RAF) < 0.8 | RAF < 0.4 ) & P.value < 0.01

```{r}
variant$af <- variant$Reads1 / (variant$Reads1 + variant$Reads2)
variant <- variant[variant$af <= .8,]
imbalance.deepsea <- variant$af > 0.7 | variant$af < 0.4
variant.ai.deepsea <- variant[imbalance.deepsea & variant$P.Value < 0.01,]
ggplot(variant.ai.deepsea) + geom_bar(aes(x = log(Odds.Ratio) > 0, y = ..count..)) + ggtitle('Reference Biased vs Alternative Biased')
ggplot(variant.ai.deepsea) + geom_point(aes(x = Alt, y = Ref, color =log(Odds.Ratio))) + scale_color_gradient2(midpoint=0, low="blue", mid="white", high="red", space ="Lab" ) + geom_abline(intercept = 0.07, slope = 1) + geom_abline(intercept = -0.07, slope = 1) + ggtitle('Predicted Ref vs. Predicted Alt')
```

# Balance vs. Imbalance

Balance: 0.45 < RAF < 0.55 & P.value > 0.05
Imbalance: (0.7 < RAF < 0.8 | RAF < 0.4) & P.value < 0.01

## Overview

```{r}
imbalance <- variant$af > 0.7 | variant$af < 0.4
balance <- variant$af < 0.55 & variant$af > 0.45
imbalance <- imbalance & variant$P.Value < 0.01
balance <- balance & variant$P.Value > 0.05
variant$Imbalance <- 'Unsure'
variant$Imbalance[imbalance] <- 'Imbalanced'
variant$Imbalance[balance] <- 'Balanced'
ggplot(variant) + geom_bar(aes(x = Imbalance, y = ..count..)) + ggtitle('Count of Balanced and Imbalanced Variants')
variant.pass <- variant
ggplot(variant) + geom_point(aes(x = Alt, y = Ref, color = log10(Odds.Ratio))) + facet_grid(.~Imbalance) + geom_abline(intercept = 0.07, slope = 1) + geom_abline(intercept = -0.07, slope = 1) + ggtitle('The Predicted Effect of Heterozygous sites in DNase-seq of wgEncodeUwDgfHcfAln') + scale_color_gradient2(midpoint=0, low="blue", mid="white", high="red", space ="Lab" )
```



## Observed Log Odds Ratio vs. Predicted Log Odds Ratio

```{r}
logodds <- function(x){
    return(log(x) - log(1-x))
}
variant$Log10.Odds.Ratio.Observed <- log10(variant$Odds.Ratio)
variant$Log10.Odds.Ratio.Predicted <- logodds(variant$Ref) - logodds(variant$Alt)
model.linear = lm(Log10.Odds.Ratio.Observed ~ 0 + Log10.Odds.Ratio.Predicted, data = variant)
ggplot(variant, aes(x = Log10.Odds.Ratio.Predicted, y = Log10.Odds.Ratio.Observed)) + geom_point(aes(color = Imbalance)) + geom_smooth(method='lm',formula=y~0+x) + annotate("text", x = 0.4, y = -1, label = lm_eqn(model.linear), parse = TRUE) + ggtitle('Observed Log Odds Ratio vs
 Predicted Log Odds Ratio')
```

### Predictive power of predicted p(ref) and p(alt)

Model: imbalance ~ f(ref, alt), link = binomial. $f_1 = |x - y|$.
$f_2 = |\log_{10}(x/(1-x)) - \log_{10}(y/(1-y))|$

```{r}
variant.pass.interest <- variant[variant$Imbalance != 'Unsure',]
model.logistic.abs <- glm(as.numeric(Imbalance == 'Imbalanced') ~ abs(Ref - Alt), family=binomial(link='logit'), data=variant.pass.interest)
model.logistic.lor <- glm(as.numeric(Imbalance == 'Imbalanced') ~ abs(Log10.Odds.Ratio.Predicted), family=binomial(link='logit'), data=variant.pass.interest)
```

```{r, results='asis'}
library(pander)
panderOptions('knitr.auto.asis', FALSE)
pander(model.logistic.abs)
pander(model.logistic.lor)
```

```{r, results='asis'}
library(precrec)
joined <- join_scores(model.logistic.abs$fitted.values, model.logistic.lor$fitted.values)
msmdat <- mmdata(joined, as.numeric(variant.pass.interest$Imbalance == 'Imbalanced'), modnames = c('f1', 'f2'))
mscurves <- evalmod(msmdat)
plot(mscurves)
pander(auc(mscurves))
```
