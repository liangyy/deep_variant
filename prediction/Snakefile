# This section makes prediction given input sequences. It generates sbatch script that is ready for submission

rule all:
    input:
        [ 'sbatch/{prefix}_{dataset}.sbatch'.format(dataset=i, prefix=config['prefix']) for i in config['data'] ]

rule predict:
    input:
        x = lambda wildcards: config['data'][wildcards.dataset],
        model = config['model']
    params:
        ypred = 'result/{prefix}_{{dataset}}.ypred.hdf5'.format(prefix=config['prefix']),
        partition = config['partition']
    output:
        'sbatch/{prefix}_{{dataset}}.sbatch'.format(prefix=config['prefix'])
    run:
        sbatch = '''#!/bin/bash
#SBATCH --job-name={prefix}_{taskname}
#SBATCH --output={prefix}_{taskname}.out
#SBATCH --error={prefix}_{taskname}.err
#SBATCH --time=24:00:00
#SBATCH --partition={partition}
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=1
#SBATCH --mem-per-cpu=50G
#SBATCH --nodes=1
#SBATCH --gres=gpu:1
cd /project2/xinhe/yanyul
source setup.sh
source activate deepvarpred_test
module load cuda/7.5
cd {wd}
python scripts/predict.py --x {x} --out {out} --model {model}
'''.format(prefix=config['prefix'], x=input.x, out=params.ypred, model=input.model, taskname=wildcards.dataset, partition=params.partition, wd=config['working_dir'])
        o = open(output[0], 'w')
        o.write(sbatch)
        o.close()
